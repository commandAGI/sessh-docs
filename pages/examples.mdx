# Examples

Comprehensive examples demonstrating how to use sessh with various cloud providers and infrastructure.

## Lambda Labs GPU Training

Complete example of launching a Lambda Labs GPU instance, training a model, and terminating:

```bash
#!/bin/bash
set -euo pipefail

export LAMBDA_API_KEY="sk_live_..."
export LAMBDA_REGION="us-west-1"
export LAMBDA_INSTANCE_TYPE="gpu_1x_h100_sxm5"
export LAMBDA_SSH_KEY="laptop-ed25519"

ALIAS="lambda-agent"
INSTANCE_ID=""
IP=""

cleanup() {
  echo "Cleaning up..."
  if [[ -n "$ALIAS" ]] && [[ -n "$IP" ]]; then
    sessh close "$ALIAS" "ubuntu@${IP}" 2>/dev/null || true
  fi
  if [[ -n "$INSTANCE_ID" ]]; then
    curl -su "$LAMBDA_API_KEY:" \
      -H "content-type: application/json" \
      -X POST https://cloud.lambdalabs.com/api/v1/instance-operations/terminate \
      -d "{\"instance_ids\": [\"$INSTANCE_ID\"]}" >/dev/null 2>&1 || true
  fi
}
trap cleanup EXIT

# Launch instance
echo "Launching Lambda Labs instance..."
RESPONSE=$(curl -su "$LAMBDA_API_KEY:" \
  -H "content-type: application/json" \
  -X POST https://cloud.lambdalabs.com/api/v1/instance-operations/launch \
  -d "{\"region_name\":\"$LAMBDA_REGION\",\"instance_type_name\":\"$LAMBDA_INSTANCE_TYPE\",\"ssh_key_names\":[\"$LAMBDA_SSH_KEY\"],\"quantity\":1}")

INSTANCE_ID=$(echo "$RESPONSE" | jq -r '.data.instance_ids[0]')
echo "Instance ID: $INSTANCE_ID"

# Wait for IP
echo "Waiting for instance IP address..."
until ip=$(curl -su "$LAMBDA_API_KEY:" \
  https://cloud.lambdalabs.com/api/v1/instances | \
  jq -r ".data[] | select(.id==\"$INSTANCE_ID\") | .ip") && [[ "$ip" != "null" ]]; do
  sleep 5
done
IP="$ip"
echo "Instance IP: $IP"

# Wait for SSH to be ready
echo "Waiting for SSH to be ready..."
for i in {1..60}; do
  if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new "ubuntu@${IP}" "echo ready" 2>/dev/null; then
    break
  fi
  sleep 5
done

# Use sessh to train model
sessh open "$ALIAS" "ubuntu@${IP}"
sessh run "$ALIAS" "ubuntu@${IP}" -- "pip install torch torchvision"
sessh run "$ALIAS" "ubuntu@${IP}" -- "python train.py"
sessh logs "$ALIAS" "ubuntu@${IP}" 400

# Cleanup happens automatically via trap
```

**Run the full example:**
```bash
export LAMBDA_API_KEY="sk_live_..."
export LAMBDA_SSH_KEY="my-ssh-key-name"
./examples/lambdalabs.sh
```

## AWS EC2 Example

Complete example of launching an EC2 instance, using sessh, and terminating:

```bash
#!/bin/bash
set -euo pipefail

export AWS_REGION="${AWS_REGION:-us-east-1}"
export INSTANCE_TYPE="${INSTANCE_TYPE:-t2.micro}"
export AWS_KEY_NAME="${AWS_KEY_NAME:-}"
export AWS_SECURITY_GROUP="${AWS_SECURITY_GROUP:-}"
ALIAS="aws-agent"

# Launch instance
LAUNCH_OUTPUT=$(aws ec2 run-instances \
  --image-id ami-xxxxx \
  --instance-type "$INSTANCE_TYPE" \
  --key-name "$AWS_KEY_NAME" \
  --security-group-ids "$AWS_SECURITY_GROUP" \
  --region "$AWS_REGION" \
  --output json)

INSTANCE_ID=$(echo "$LAUNCH_OUTPUT" | jq -r '.Instances[0].InstanceId')

# Wait for instance to be running
aws ec2 wait instance-running --instance-ids "$INSTANCE_ID" --region "$AWS_REGION"

# Get IP address
IP=$(aws ec2 describe-instances \
  --instance-ids "$INSTANCE_ID" \
  --query 'Reservations[0].Instances[0].PublicIpAddress' \
  --output text \
  --region "$AWS_REGION")

# Wait for SSH to be ready
for i in {1..60}; do
  if ssh -o ConnectTimeout=5 -o StrictHostKeyChecking=accept-new "ubuntu@${IP}" "echo ready" 2>/dev/null; then
    break
  fi
  sleep 5
done

# Use sessh
sessh open "$ALIAS" "ubuntu@${IP}"
sessh run "$ALIAS" "ubuntu@${IP}" -- "sudo apt-get update -qq"
sessh run "$ALIAS" "ubuntu@${IP}" -- "python3 train.py"
sessh logs "$ALIAS" "ubuntu@${IP}" 400

# Terminate
sessh close "$ALIAS" "ubuntu@${IP}"
aws ec2 terminate-instances --instance-ids "$INSTANCE_ID" --region "$AWS_REGION"
```

**Run the full example:**
```bash
export AWS_REGION=us-east-1
export AWS_KEY_NAME=my-key
export AWS_SECURITY_GROUP=sg-xxxxx
./examples/aws.sh
```

## Local/Localhost Example

Simple example for using sessh with a local machine or VM:

```bash
#!/bin/bash
set -euo pipefail

HOST="${1:-localhost}"
USER="${USER:-$(whoami)}"
ALIAS="local-test"

cleanup() {
  sessh close "$ALIAS" "${USER}@${HOST}" 2>/dev/null || true
}
trap cleanup EXIT

# Open session
sessh open "$ALIAS" "${USER}@${HOST}"

# Run commands (state persists between commands)
sessh run "$ALIAS" "${USER}@${HOST}" -- "echo 'Hello from sessh!'"
sessh run "$ALIAS" "${USER}@${HOST}" -- "pwd"
sessh run "$ALIAS" "${USER}@${HOST}" -- "cd /tmp && pwd && echo 'State persisted!'"

# Get logs
sessh logs "$ALIAS" "${USER}@${HOST}" 50

# Check status
sessh status "$ALIAS" "${USER}@${HOST}"
```

**Run the full example:**
```bash
# Linux/macOS (bash)
./examples/local.sh localhost
```

```powershell
# Windows (PowerShell)
.\examples\local.ps1 localhost
```

## Python SDK Examples

### Using Python SDK

```python
from sessh import SesshClient

# Create client
client = SesshClient(alias="agent", host="ubuntu@203.0.113.10")

# Open session
client.open()

# Run commands
client.run("pip install torch")
client.run("python train.py")

# Get logs
logs = client.logs(400)
print(logs["output"])

# Close
client.close()
```

## TypeScript SDK Examples

### Using TypeScript SDK

```typescript
import { SesshClient } from "sessh-sdk";

// Create client
const client = new SesshClient({
  alias: "agent",
  host: "ubuntu@203.0.113.10"
});

// Open session
await client.open();

// Run commands
await client.run("pip install torch");
await client.run("python train.py");

// Get logs
const logs = await client.logs(400);
console.log(logs.output);

// Close
await client.close();
```

## Common Patterns

### Autonomous Workflows

Fully automated infrastructure management:

```bash
# Bootstrap EC2 instance
aws ec2 run-instances ... > /tmp/i.json
iid=$(jq -r '.Instances[0].InstanceId' /tmp/i.json)
aws ec2 wait instance-status-ok --instance-ids "$iid"
ip=$(aws ec2 describe-instances ... --query '...' --output text)

# Provision and train
sessh open agent "ubuntu@$ip"
sessh run agent "ubuntu@$ip" -- "sudo apt-get update && sudo apt-get install -y python3-pip"
sessh run agent "ubuntu@$ip" -- "pip install torch && python train.py"
sessh logs agent "ubuntu@$ip"
sessh close agent "ubuntu@$ip"

# Terminate
aws ec2 terminate-instances --instance-ids "$iid"
```

### CI/CD

Long-running jobs on remote infrastructure:

```bash
# Build and test on remote
sessh open builder "build@ci-host"
sessh run builder "build@ci-host" -- "cd /repo && make build"
sessh run builder "build@ci-host" -- "make test"
sessh logs builder "build@ci-host" 1000
```

### Development

Persistent remote development environments:

```bash
# Open session, work, detach, reattach later
sessh open dev "user@dev-server"
sessh attach dev "user@dev-server"  # Ctrl+B, D to detach
# ... later ...
sessh attach dev "user@dev-server"  # Resume where you left off
```

All examples follow the same pattern:
1. Launch infrastructure (instance/container)
2. Wait for SSH to be ready
3. Open sessh session
4. Run commands (state persists between commands)
5. Fetch logs
6. Clean up resources

